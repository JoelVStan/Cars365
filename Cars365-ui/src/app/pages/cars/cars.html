<div class="mb-5">
  <h2 class="mb-4 text-center fw-bold">
  <i class="bi bi-car-front-fill text-primary"></i>
    Explore Used Cars
  </h2>

  <div class="filter-bar mb-4 shadow-sm bg-white">

    <!-- ROW 1: SEARCH + BRAND + SORT -->
    <div class="row g-3 align-items-center filter-row-primary">

      <!-- Search -->
      <div class="col-md-5">
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input
            type="text"
            class="form-control"
            placeholder="Search by brand or model"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
          />
        </div>
      </div>

      <!-- Brand -->
      <div class="col-md-3">
        <select
          class="form-select"
          [(ngModel)]="selectedBrand"
          (change)="onFilterChange()"
        >
          <option value="">All Brands</option>
          @for (brand of brands; track brand) {
            <option [value]="brand">{{ brand }}</option>
          }
        </select>
      </div>

      <!-- Sort -->
      <div class="col-md-4">
        <select
          class="form-select"
          [(ngModel)]="selectedSort"
          (ngModelChange)="onSortChange($event)"
        >
          <option value="">Sort: Default</option>
          <option value="priceAsc">Price: Low â†’ High</option>
          <option value="priceDesc">Price: High â†’ Low</option>
          <option value="yearDesc">Cars Age: New â†’ Old</option>
          <option value="yearAsc">Cars Age: Old â†’ New</option>
        </select>
      </div>

    </div>

    <hr class="my-3">

    <!-- ROW 2: FILTERS -->
    <div class="row g-3 align-items-end filter-row-secondary">

      <!-- Fuel -->
      <div class="col-md-2">
        <label class="form-label small">Fuel</label>
        <select class="form-select" [(ngModel)]="filters.fuelType" (change)="onFilterChange()">
          <option value="">All</option>
          <option>Petrol</option>
          <option>Diesel</option>
          <option>Electric</option>
          <option>CNG</option>
          <option>Hybrid</option>
        </select>
      </div>

      <!-- Transmission -->
      <div class="col-md-2">
        <label class="form-label small">Transmission</label>
        <select class="form-select" [(ngModel)]="filters.transmission" (change)="onFilterChange()">
          <option value="">All</option>
          <option>Manual</option>
          <option>Automatic</option>
        </select>
      </div>

      <!-- Type -->
      <div class="col-md-2">
        <label class="form-label small">Type</label>
        <select class="form-select" [(ngModel)]="filters.type" (change)="onFilterChange()">
          <option value="">All</option>
          <option>Hatchback</option>
          <option>Sedan</option>
          <option>SUV</option>
          <option>MUV</option>
          <option>Coupe</option>
        </select>
      </div>

      <!-- Price -->
      <div class="col-md-4">
        <label class="form-label small">Max Price</label>
        <input
          type="range"
          class="form-range"
          min="100000"
          max="3000000"
          step="50000"
          [(ngModel)]="filters.maxPrice"
          (input)="onFilterChange()"
        />
        <div class="small text-muted">
          Up to â‚¹ {{ formatPrice(filters.maxPrice) }}
        </div>
      </div>

      <!-- Clear -->
      <div class="col-md-2 text-end">
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm w-75"
          (click)="clearFilters()"
        >
          <i class="bi bi-x-circle"></i> Clear
        </button>
      </div>

    </div>
  </div>



  @if (loading) {
    <div class="row g-4">
      @for (i of [1,2,3,4,5,6]; track i) {
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow border-0 car-card skeleton-card">

            <!-- Image Skeleton -->
            <div class="skeleton-image"></div>

            <div class="card-body">
              <!-- Title + Price -->
              <div class="d-flex justify-content-between mb-2">
                <div class="skeleton-text title"></div>
                <div class="skeleton-text price"></div>
              </div>

              <!-- Pills -->
              <div class="d-flex gap-2">
                <div class="skeleton-pill"></div>
                <div class="skeleton-pill"></div>
              </div>
            </div>

            <div class="card-footer bg-white border-0">
              <div class="skeleton-button"></div>
            </div>

          </div>
        </div>
      }
    </div>
  } @else {

    @if (filteredCars.length === 0) {
      <div class="alert alert-info text-center">
        No cars available at the moment ðŸš—
      </div>
    } @else {

      <div class="row g-4">
        @for (car of filteredCars; track car.id) {

          <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow border-0 car-card">

              <!-- Image -->
              <div class="position-relative">
                <img
                  [src]="getImageUrl(car.imageUrl)"
                  class="card-img-top"
                  alt="Car image"
                />

                <!-- Car Type -->
                <span class="badge bg-success position-absolute top-0 end-0 m-2">
                  {{ car.type }}
                </span>

                <!-- Cars365 Guaranteed -->
                <span class="badge bg-primary position-absolute bottom-0 start-0 m-2">
                  Cars365 Guaranteed
                </span>

                @if (authService.isLoggedIn() && !authService.isAdmin()) {
                  <!-- Wishlist Button -->
                <button
                  class="wishlist-btn"
                  (click)="toggleWishlist(car.id)"
                >
                  <i
                    class="bi"
                    [ngClass]="isWishlisted(car.id) ? 'bi-heart-fill text-danger' : 'bi-heart'"
                  ></i>
                </button>
                }
              </div>

              <!-- Body -->
              <div class="card-body">

                <!-- Title + Price -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="fw-semibold mb-0">
                    {{ car.year }} {{ car.brand }} {{ car.model }}
                  </h5>

                  <span class="fw-bold text-primary fs-6">
                    â‚¹ {{ formatPrice(car.price) }}
                  </span>
                </div>

                <!-- Fuel & Transmission Pills -->
                <div class="d-flex gap-2">
                  <span class="badge rounded-pill bg-light text-dark border">
                    {{ car.fuelType }}
                  </span>

                  <span class="badge rounded-pill bg-light text-dark border">
                    {{ car.transmission }}
                  </span>
                </div>

              </div>

              <!-- Footer -->
              <div class="card-footer bg-white border-0 text-center mb-2">
                @if (isAdmin) {
                  <div class="d-flex gap-2">
                    <button
                      class="btn btn-outline-primary btn-sm w-50"
                      [routerLink]="['/admin/edit', car.id]">
                      <i class="bi bi-pencil"></i> Edit
                    </button>


                    <button
                      class="btn btn-outline-danger btn-sm w-50"
                      (click)="deleteCar(car.id)">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                    <button class="btn btn-outline-primary btn-sm w-100" [routerLink]="['/cars', car.id]">
                      View Details
                    </button>
                  </div>
                } @else {
                  <button class="btn btn-outline-primary btn-sm w-100" [routerLink]="['/cars', generateCarSlug(car)]">
                    View Details
                  </button>
                }
              </div>

            </div>
          </div>

        }
      </div>

    }
  }

</div>