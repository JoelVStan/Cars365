@if (loading) {
  <div class="text-center mt-5">
    <div class="spinner-border text-primary"></div>
  </div>
}

@if (!loading && car) {
  <div class="car-details-page">

    <div class="row g-4">

      <!-- LEFT: IMAGE + BADGES -->
      <div class="col-lg-7">

        <div class="image-card position-relative">

          <!-- Main Image -->
          <img
            [src]="selectedImage"
            class="img-fluid car-hero-img"
            alt="Car image"
          />

          <!-- Arrows -->
          @if (galleryImages.length > 1) {
            <button class="nav-arrow left" (click)="prevImage()">
              <i class="bi bi-chevron-left"></i>
            </button>

            <button class="nav-arrow right" (click)="nextImage()">
              <i class="bi bi-chevron-right"></i>
            </button>
          }

          <!-- Trust badge -->
          <span class="badge trust-badge">
            Cars365 Guaranteed
          </span>

        </div>

        <!-- Thumbnails -->
        @if (galleryImages.length > 1) {
          <div class="thumbnail-strip mt-3">
            @for (img of galleryImages; track img.id; let i = $index) {
              <img
                [src]="img.fullUrl"
                class="thumb"
                [class.active]="i === currentIndex"
                (click)="selectImage(i)"
              />
            }
          </div>
        }

        @if (!authService.isLoggedIn()) {
          <div class="detail-specs mt-3">
            
              <small
                class="login-hint text-primary"
                role="button"
                (click)="goToLogin()"
              >
                Login to view full details
              </small>
          </div>
        }
        <!-- Detailed Specs (Below Image) -->
        <div class="detail-specs mt-3 mb-3">

          <div class="detail-item">
            <i class="bi bi-speedometer2"></i>
            <div>
              <span class="label">Kms Driven</span>
              <span
                class="value"
                [class.blur-text]="!authService.isLoggedIn()"
              >
                {{ car.kmsDriven | number }} km
              </span>
            </div>
          </div>

          <div class="detail-item">
            <i class="bi bi-person-badge"></i>
            <div>
              <span class="label">Ownership</span>
              <span class="value">
                {{ car.ownership }}{{ getOwnershipSuffix(car.ownership) }} Owner
              </span>
            </div>
          </div>

          <div class="detail-item">
            <i class="bi bi-credit-card-2-front"></i>
            <div>
              <span class="label">Registration</span>
              <span class="value" [class.blur-text]="!authService.isLoggedIn()">{{ car.registrationCode }}</span>
            </div>
          </div>

          <div class="detail-item">
            <i class="bi bi-calendar-event"></i>
            <div>
              <span class="label">Make Year</span>
              <span class="value">{{ car.year }}</span>
            </div>
          </div>

          <div class="detail-item">
            <i class="bi bi-calendar2-check"></i>
            <div>
              <span class="label">Registration Date</span>
              <span class="value" [class.blur-text]="!authService.isLoggedIn()">
                {{ car.registrationYear | date:'MMM yyyy' }}
              </span>
            </div>
          </div>

          @if (car.fuelType != 'Electric') {
            <div class="detail-item">
            <i class="bi bi-gear-wide-connected"></i>
            <div>
              <span class="label">Engine</span>
              <span class="value">{{ car.engineCC }} cc</span>
            </div>
          </div>}
          

          <div class="detail-item">
            <i class="bi bi-shield-check"></i>
            <div>
              <span class="label">Insurance Till</span>
              <span class="value" [class.blur-text]="!authService.isLoggedIn()">
                {{ insuranceDisplay(car.insuranceTill) }}
              </span>
            </div>
          </div>

          <div class="detail-item">
            <i class="bi bi-key"></i>
            <div>
              <span class="label">Spare Key</span>
              <span
                class="value"
                [class.text-success]="car.hasSpareKey"
                [class.text-danger]="!car.hasSpareKey"
              >
                {{ car.hasSpareKey ? 'Available' : 'Not Available' }}
              </span>
            </div>
          </div>

        </div>

                  <!-- EMI CALCULATOR -->
         @if (car.price > 300000) {
          <div class="emi-card mt-4">

          <h6 class="mb-3 d-flex justify-content-between align-items-center">
            <span>
              <i class="bi bi-calculator me-1"></i>
              EMI Calculator
            </span>
            @if (!authService.isLoggedIn()) {
              <small
                class="login-hint text-primary"
                role="button"
                (click)="goToLogin()"
              >
                Login to view
              </small>
            }
          </h6>

          <div [class.blur-text]="!authService.isLoggedIn()">
              <!-- INPUTS -->
            <div class="row g-3">

              <!-- Down Payment -->
              <div class="col-md-4">
                <label class="small text-muted">Down Payment (₹)</label>
                <input
                  type="number"
                  class="form-control fancy-input"
                  [value]="emi.downPayment"
                  (input)="emi.downPayment = $any($event.target).valueAsNumber || 0"
                />
              </div>

              <!-- Interest -->
              <div class="col-md-4">
                <label class="small text-muted">Interest Rate (%)</label>
                <input
                  type="number"
                  step="0.1"
                  class="form-control fancy-input"
                  [value]="emi.interestRate"
                  (input)="emi.interestRate = $any($event.target).valueAsNumber || 0"
                />
              </div>

              <!-- Tenure -->
              <div class="col-md-4">
                <label class="small text-muted">Loan Tenure</label>
                <select
                  class="form-select fancy-input"
                  [ngModel]="emi.tenureYears"
                  (ngModelChange)="emi.tenureYears = $event"
                >
                  <option [ngValue]="3">3 Years</option>
                  <option [ngValue]="4">4 Years</option>
                  <option [ngValue]="5">5 Years</option>
                  <option [ngValue]="6">6 Years</option>
                  <option [ngValue]="7">7 Years</option>
                </select>
              </div>

            </div>

            <!-- RESULT SUMMARY -->
            <div class="emi-summary mt-4">

              <div class="emi-box">
                <span class="label">Principal Amount</span>
                <span class="value">₹ {{ loanAmount | number }}</span>
              </div>

              <div class="emi-box">
                <span class="label">Total Interest</span>
                <span class="value text-danger">
                  ₹ {{ totalInterest | number }}
                </span>
              </div>

              <div class="emi-box highlight">
                <span class="label">Monthly EMI</span>
                <span class="emi-value">
                  ₹ {{ monthlyEmi | number }}
                </span>
              </div>

              <div class="emi-box">
                <span class="label">Total Payable</span>
                <span class="value text-success">
                  ₹ {{ totalPayable | number }}
                </span>
              </div>

            </div>
          </div>

        </div>
         }
         @else {
          <div class="emi-card mt-4">

          <h6 class="mb-1">
            <i class="bi bi-calculator me-1"></i>
            No Loan Available
          </h6>
         </div>
          
         }
        
        <!-- @else {
          <div class="emi-card mt-4">

          <h6 class="mb-1">
            <i class="bi bi-calculator me-1"></i>
            EMI Calculator
            <p
              class="login-hint text-primary"
              role="button"
              (click)="goToLogin()"
            >
              Login to view
          </p>
          </h6>
         </div>
        } -->

        



      </div>

      <!-- RIGHT: DETAILS -->
      <div class="col-lg-5">
        <div class="details-sticky">
        <div class="details-card">

          <!-- Title -->
          <h3 class="car-title">
            {{ car.year }} {{ car.brand }} {{ car.model }}
            <span class="car-variant">
              {{ car.variant }}
            </span>
          </h3>

          <p class="text-muted mb-3">
            {{ car.type }}
          </p>

            <div class="sticky-price-card">

                <div class="price-box mb-2">
                    ₹ {{ formatPriceToLakhs(car.price) }}
                </div>

                @if (car.price > 300000) {
                <div class="emi-boxer">
                    EMI starts at
                    <strong>
                    ₹ {{ calculateEmi(car.price) | number }}
                    </strong>
                    / month*
                </div>
                }

            </div>

            @if(!authService.isAdmin()){
              <div class="test-drive-card mt-4">

                <h6>
                  <i class="bi bi-car-front me-1"></i>
                  Book a Test Drive
                </h6>

                @if (!authService.isLoggedIn()) {
                  <button class="btn btn-outline-primary w-100"
                          routerLink="/login"
                          [queryParams]="{ returnUrl: router.url }">
                    Login to Book Test Drive
                  </button>
                }

                @else if (existingRequest) {
                  <span class="badge w-100 py-2"
                        [ngClass]="{
                          'bg-warning': existingRequest.status === 'Pending',
                          'bg-success': existingRequest.status === 'Approved',
                          'bg-danger': existingRequest.status === 'Rejected',
                          'bg-secondary': existingRequest.status === 'Completed'
                        }">
                    {{ existingRequest.status }}
                  </span>
                }

                @else {
                  <div class="mt-2">
                    <label class="small">Preferred Date</label>
                    <input type="date"
                          class="form-control mb-2"
                          [(ngModel)]="testDrive.preferredDate" />

                    <label class="small">Time Slot</label>
                    <select class="form-select mb-3"
                            [(ngModel)]="testDrive.timeSlot">
                      <option value="">Select</option>
                      <option>10 AM – 12 PM</option>
                      <option>12 PM – 2 PM</option>
                      <option>2 PM – 4 PM</option>
                      <option>4 PM – 6 PM</option>
                    </select>

                    <button class="btn btn-primary w-100"
                            (click)="requestTestDrive()">
                      Request Test Drive
                    </button>
                  </div>
                }

              </div>
            }



          <!-- Specs -->
          <div class="spec-grid mb-4 mt-4">
            <div class="spec-item">
              <i class="bi bi-fuel-pump"></i>
              <span>{{ car.fuelType }}</span>
            </div>

            <div class="spec-item">
              <i class="bi bi-gear"></i>
              <span>{{ car.transmission }}</span>
            </div>

            <div class="spec-item">
              <i class="bi bi-car-front"></i>
              <span>{{ car.type }}</span>
            </div>
          </div>

          <!-- Description -->
          <div class="description-box mb-4">
            <h6>About the vehicle</h6>
            <p>
              {{ car.description || 'Well maintained car with a smooth driving experience.' }}
            </p>
          </div>

          <!-- WHY BUY -->
            <div class="why-buy-card mt-4">
            <h6>Why buy from Cars365?</h6>

            <ul>
                <li>
                <i class="bi bi-shield-check"></i>
                Verified & quality-checked cars
                </li>
                <li>
                <i class="bi bi-currency-rupee"></i>
                Transparent pricing & no hidden charges
                </li>
                <li>
                <i class="bi bi-arrow-repeat"></i>
                Hassle-free ownership transfer
                </li>
                <li>
                <i class="bi bi-headset"></i>
                Dedicated customer support
                </li>
            </ul>
            </div>

            @if (authService.isLoggedIn()) {
              <div class="share-row mt-3">
              <span class="share-label">Share this car</span>

              <div class="share-icons">
                <button class="icon-btn" (click)="copyLink()" title="Copy link">
                  <i class="bi bi-clipboard"></i>
                </button>

                <button class="icon-btn whatsapp" (click)="shareWhatsApp()" title="WhatsApp">
                  <i class="bi bi-whatsapp"></i>
                </button>

                <button class="icon-btn telegram" (click)="shareTelegram()" title="Telegram">
                  <i class="bi bi-telegram"></i>
                </button>

                <button class="icon-btn gmail" (click)="shareGmail()" title="Gmail">
                  <i class="bi bi-envelope"></i>
                </button>
              </div>
            </div>
            }
            


          <!-- Actions -->
          <div class="action-buttons mt-3">
            <button class="btn btn-dark w-100 mb-2">
              Contact Seller
            </button>

            <button
              class="btn btn-outline-secondary w-100"
              routerLink="/cars"
            >
              ← Back to Cars
            </button>
          </div>

        </div>
        </div>
      </div>

    </div>
  </div>
}
