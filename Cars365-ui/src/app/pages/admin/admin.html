<div class="add-car-wrapper">

  <!-- Header -->
  <div class="add-car-header">
    <h3>
      <i class="bi" [class.bi-pencil]="isEditMode" [class.bi-car-front-fill]="!isEditMode"></i> {{ isEditMode ? 'Edit Car Listing' : 'Create Car Listing' }}
    </h3>
    <p class="text-muted">Add a premium used car to Cars365 inventory</p>
  </div>

  <!-- STEPPER -->
  <div class="stepper mb-4">
    <div class="step" [class.active]="currentStep >= 1">
      <span>1</span>
      <label>Basics</label>
    </div>
    <div class="step" [class.active]="currentStep >= 2">
      <span>2</span>
      <label>Specs</label>
    </div>
    <div class="step" [class.active]="currentStep >= 3">
      <span>3</span>
      <label>Publish</label>
    </div>
  </div>


  <form
    [formGroup]="carForm"
    (ngSubmit)="submit()"
    class="add-car-card"
  >
    @if (currentStep === 1) {
      <!-- IMAGE UPLOAD HERO -->
      <div class="image-upload-box">
        
        @if (!imagePreview && !isImageLoading) {
          <label class="upload-placeholder">
            <i class="bi bi-cloud-arrow-up"></i>
            <span>Upload Car Thumbnail Image</span>
            <small>JPEG / PNG</small>

            <input
              #fileInput
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
            />
          </label>
        }

        @if (isImageLoading) {
          <div class="image-loading">
            <div class="spinner-border text-primary"></div>
            <p>Processing image...</p>
          </div>
        }

        @if (imagePreview && !isImageLoading) {
          <div class="image-preview-wrapper">
            <img [src]="imagePreview" />
            <button
              type="button"
              class="remove-image-btn"
              (click)="removeImage()"
            >
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        }

      </div>

      <!-- CAR BASICS -->
      <div class="form-section">
        <h5>Car Basics</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Brand</label>
            <select
              class="form-select fancy-input"
              formControlName="carBrandId"
            >
              <option value="">Select Brand</option>
              @for (b of brands; track b.id) {
                <option [ngValue]="b.id">{{ b.name }}</option>
              }
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Model</label>
            <select
              class="form-select fancy-input"
              formControlName="carModelId"
              [disabled]="!models.length"
            >
              <option value="">Select Model</option>
              @for (m of models; track m.id) {
                <option [ngValue]="m.id">{{ m.name }}</option>
              }
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">
              Variant
              <span class="text-muted">(Optional)</span>
            </label>
            <input
              class="form-control fancy-input"
              placeholder="e.g. SX(O), Sportz, VXi, ZXI+"
              formControlName="variant"
            />
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Make Year</label>
            <input
              type="number"
              class="form-control fancy-input year-input"
              placeholder="Year"
              formControlName="year"
              min="1990"
              max="2099"
            >
          </div>
        </div>
      </div>
    }
    @if (currentStep === 2) {
      <!-- SPECS -->
      <div class="form-section">
        <h5>Specifications</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Car Type</label>
            <select class="form-select fancy-input" formControlName="type">
              <option value="">Car Type</option>
              @for (type of carTypes; track type) {
                <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Fuel</label>
            <select class="form-select fancy-input" formControlName="fuelType">
              <option value="">Fuel</option>
              @for (fuel of fuelTypes; track fuel) {
                <option [value]="fuel">{{ fuel }}</option>
              }
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Transmission</label>
            <select class="form-select fancy-input" formControlName="transmission">
              <option value="">Transmission</option>
              @for (t of transmissions; track t) {
                <option [value]="t">{{ t }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <!-- ADDITIONAL VEHICLE DETAILS -->
      <div class="form-section">
        <h5>Vehicle Details</h5>

        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Kms Driven</label>
            <input
              type="number"
              class="form-control fancy-input"
              placeholder="Kms Driven"
              formControlName="kmsDriven"
            >
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Ownership</label>
            <select
              class="form-select fancy-input"
              formControlName="ownership"
            >
              <option value="">Ownership</option>
              <option [value]="1">1st Owner</option>
              <option [value]="2">2nd Owner</option>
              <option [value]="3">3rd Owner</option>
              <option [value]="4">4th Owner+</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">Registration (KL-07)</label>
            <input
              class="form-control fancy-input"
              placeholder="Registration Code (e.g. KL-07)"
              formControlName="registrationCode"
            >
          </div>

          <div class="col-md-4">
            <label class="form-label small fw-semibold text-muted">Reg Month & Year</label>
            <input
              type="month"
              class="form-control fancy-input"
              formControlName="registrationYear"
            >
          </div>

          <div class="col-md-4">
            <label class="form-label small fw-semibold text-muted">Engine Capacity (cc)</label>
            <input
              type="number"
              class="form-control fancy-input"
              placeholder="Engine Capacity (cc)"
              formControlName="engineCC"
            >
          </div>

          <div class="col-md-4">
            <label class="form-label small fw-semibold text-muted">Insurance Till</label>
            <input
              type="month"
              class="form-control fancy-input"
              formControlName="insuranceTill"
            >
          </div>

          <div class="col-md-4">
            <label class="form-label small fw-semibold text-muted">Spare Key Available?</label>
            <select
              class="form-select fancy-input"
              formControlName="hasSpareKey"
            >
              <option value="">Spare Key Available?</option>
              <option [value]="true">Yes</option>
              <option [value]="false">No</option>
            </select>
          </div>

        </div>
      </div>

      <!-- PRICE -->
      <div class="form-section">
        <h5>Pricing</h5>

        <div class="price-box">
          <span>₹</span>
          <input
            type="number"
            class="price-input"
            placeholder="Enter price"
            formControlName="price"
          />
        </div>

        <!-- Live formatted price -->
        @if (carForm.get('price')?.value) {
          <div class="price-preview">
            {{ formatPriceToLakhs(carForm.get('price')?.value) }}
          </div>
        }
      </div>

    }

    @if (currentStep === 3) {
          <!-- DESCRIPTION -->
      <div class="form-section">
        <h5>
          Description
          <button
            type="button"
            class="btn btn-sm btn-outline-primary ms-2"
            (click)="generateDescription()"
          >
            ✨ Generate
          </button>
        </h5>

        <textarea
          class="form-control fancy-input"
          rows="3"
          placeholder="Condition, ownership, highlights..."
          formControlName="description"
        ></textarea>
      </div>

      @if (isEditMode) {
        <div class="form-section">
          <h5>Existing Gallery</h5>

          @if (existingImages.length === 0) {
            <p class="text-muted small">No gallery images uploaded yet.</p>
          }

          <div
            class="admin-gallery"
            cdkDropList
            (cdkDropListDropped)="onReorder($event)"
          >
            @for (img of existingImages; track img.id) {
              <div class="admin-thumb" cdkDrag>

                <img [src]="img.fullUrl" />

                <!-- Primary badge -->
                @if (img.isPrimary) {
                  <span class="primary-badge">Primary</span>
                }

                <!-- Actions -->
                <div class="thumb-actions">
                  <button
                    type="button"
                    class="btn-icon star"
                    [class.active]="img.isPrimary"
                    (click)="setPrimary(img.id)"
                    title="Set as primary"
                  >
                    <i class="bi bi-star-fill"></i>
                  </button>

                  <button
                    type="button"
                    class="btn-icon delete"
                    (click)="deleteImage(img.id)"
                    title="Delete image"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>

              </div>

            }
          </div>
        </div>


          <label class="gallery-upload-box">
            <i class="bi bi-images"></i>
            <span>Add car images</span>
            <input
              type="file"
              multiple
              accept="image/*"
              (change)="onGallerySelected($event)"
            />
          </label>

          @if (galleryPreviews.length > 0) {
            <div class="gallery-preview mt-3">
              @for (img of galleryPreviews; track img) {
                <img [src]="img" />
              }
            </div>

            <button
              type="button"
              class="btn btn-outline-primary mt-3"
              [disabled]="isGalleryUploading"
              (click)="uploadGallery()"
            >
              <i class="bi bi-cloud-upload"></i>
              {{ isGalleryUploading ? 'Uploading...' : 'Upload Gallery Image(s)' }}
            </button>
          }
        
      }


      <!-- SUBMIT -->
      <button class="publish-btn">
        <i class="bi bi-check-circle"></i> Publish Car
      </button>
    }
    
    <div class="step-actions mt-4">
    @if (currentStep > 1) {
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="prevStep()"
      >
        ← Back
      </button>
    }

    @if (currentStep < 3) {
      <button
        type="button"
        class="btn btn-primary ms-auto"
        (click)="nextStep()"
      >
        Next →
      </button>
    }
  </div>

  </form>
</div>
